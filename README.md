# adaptive-hydrostability
This code repository is associated with the manuscript: Adaptive sampling for hydrodynamic stability. https://arxiv.org/abs/2512.13532

The repository contains the MATLAB and Python code used to generate hydrodynamic stability datasets with IFISS software package (version 3.7) and to perform adaptive sampling using the KRnet, a flow-based deep generative model.

Only codes written by the author are included. External software (IFISS and KRnet) must be downloaded separately.

---

## Requirements

- TensorFlow >= 2.0
- TensorFlow Probability

---

## Folder Structure

```
adaptive-hydrostability/
├── matlab_ifiss_wrappers/ # MATLAB Scripts and functions to generate labelled training data using IFISS 
├── *.py  # All Python scripts 
├── data/ # Initial training datasets and datasets generated by KRnet for first adaptive step
├── Figure_Validation/ # Figures for validation
```

---

## External Dependencies (Not Included)


### IFISS v3.7
Download from:  
- https://www.manchester.ac.uk/ifiss  
- https://github.com/mcbssds/IFISS_download

#### MATLAB & IFISS Path Configuration

After downloading, ensure that IFISS is installed and correctly added to your MATLAB path, following the instructions provided in the IFISS user guide.

**Important:**  
The MATLAB executable path and IFISS installation folder must be specified by the user. The code assumes the MATLAB executable and IFISS folder are accessible by providing the correct paths in python script (`bifurcation_das.py`). Users do not need to replicate the folder structure of the developer’s machine.

Copy the MATLAB functions and scripts from `matlab_ifiss_wrappers/` into the IFISS directory (where `setpath.m` etc. are located).


### KRnet (Flow-Based deep Generative Model)

This project uses KRnet, adapted from:  *"DAS-PINNs: A deep adaptive sampling method for solving high-dimensional PDEs"*.

The implementation of KRnet relies on three Python scripts from the original repository:

- `BR_data.py`
- `BR_layers.py`
- `BR_model.py`

These scripts are located in the `BR_lib/` folder in the DAS-PINNs repository.

**Important:** We do **not redistribute the full DAS-PINNs code**. Users must download the repository from:

- https://github.com/MJfadeaway/DAS 

and only copy the `BR_lib/` folder (containing the three scripts above) into the main project folder adaptive-hydrostability/.

---

## Running the Code

To check out the data-processing software, download and unpack the file adaptive-hydrostability.gz

This repository provides the full code for the workflow, allowing users to run any number of adaptive steps for each of the three problems included in the manuscript: Symmetry-breaking Channel Flow, Rayleigh–Benard Convection, and Differentially Heated Cavity.

For convenience and quick testing, small example datasets are included, corresponding to a single adaptive step.

### Cut-Down Test

- Initial points: 10
- New sampling points: 10
- Purpose: Demonstrate the workflow without requiring large-scale computation.


The `data/` folder contains the initial training datasets (10 initial training points). These initial training datasets were generated using IFISS v3.7 via the MATLAB driver scripts provided in `matlab_ifiss_wrappers/`. The drivers for generating the initial training datasets are:

- Channel flow: problem1_driver.m
- Rayleigh--Benard convection: problem2_driver.m
- Differentially heated cavity: problem3_driver.m 

The associated data files (problem1.txt, problem2.txt, problem3.txt) included in this repository were generated using MATLAB R2025a running on a 2023 MacBook Pro (MacOS 15.7.3).

### Steps to run the example:

python hydro_train.py 

When hydro_train.py is run on these examples, it also generates 10 new sample points using KRNet for the first adaptive step, which are also included in the `data/` folder for each problem. 

To label the new points, the Python script calls the MATLAB functions included in matlab_ifiss_wrappers/:

- run_channel_flow_parallel.m – Channel Flow
- run_rbc_parallel.m – Rayleigh-Benard Convection
- run_dhc_parallel.m – Differentially Heated Cavity


## Generating Validation Figures

To produce representative figures using the example datasets:

1. First, train the model with the included examples (10 initial training points) using `hydro_train.py`.

2. Then, run the plotting script to visualize the training data classifications and bifurcation boundary:
- python plot_bifurcation_boundary.py --probsetup 1  
- python plot_bifurcation_boundary.py --probsetup 2
- python plot_bifurcation_boundary.py --probsetup 3

NOTE: This step is only for validation purposes. These pictures are not added in the manuscript.
      
Figure location: The example figures for each problem are provided in the folder `Figure_Validation`. These figures show the training data classifications and bifurcation boundary for validation purposes.


